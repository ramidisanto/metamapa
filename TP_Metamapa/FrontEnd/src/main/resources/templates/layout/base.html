<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security6"
    th:classappend="${@environment.getProperty('app.theme', 'light') == 'dark' ? 'dark' : ''}">

<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} ?: 'MetaMapa'">MetaMapa</title>

    <!-- Theme initialization - MUST BE FIRST to prevent flash -->
    <script>
        (function () {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind / build CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <!-- Custom overrides -->
    <link rel="stylesheet" th:href="@{/css/custom.css}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        #map {
            height: 400px;
            width: 100%;
            border-radius: 1rem;
            border: 2px solid #e5e7eb;
        }
    </style>

    <link rel="icon" th:href="@{/images/logo.png}" type="image/png">
</head>

<body>

    <header th:fragment="header"
        class="bg-gradient-to-r from-primary-50 via-white to-primary-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 shadow-soft sticky top-0 z-[1000] border-b border-primary-100 dark:border-gray-700 transition-colors duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 flex items-center justify-center">
                    <img th:src="@{/images/logo.png}" alt="MetaMapa Logo" class="w-10 h-10">
                </div>
                <a th:href="@{/}"
                    class="text-2xl font-bold bg-gradient-to-r from-primary-700 to-primary-900 dark:from-primary-400 dark:to-primary-300 bg-clip-text text-transparent tracking-tight hover:from-primary-800 hover:to-primary-950 transition-all">
                    MetaMapa
                </a>
            </div>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center gap-1">
                <a th:href="@{/}" th:classappend="${activePage == 'inicio'} ? 'nav-link-active' : ''" class="nav-link">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                    <span>Inicio</span>
                </a>
                <a th:href="@{/navegar}" th:classappend="${activePage == 'navegar'} ? 'nav-link-active' : ''"
                    class="nav-link">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z" />
                    </svg>
                    <span>Navegar</span>
                </a>
                <a th:href="@{/estadisticas}" th:classappend="${activePage == 'estadisticas'} ? 'nav-link-active' : ''"
                    class="nav-link">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg>
                    <span>Estadísticas</span>
                </a>
            </nav>

            <!-- Actions -->
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button id="theme-toggle"
                    class="w-10 h-10 rounded-xl bg-primary-100 dark:bg-gray-700 flex items-center justify-center text-primary-700 dark:text-yellow-400 hover:bg-primary-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all duration-300">
                    <!-- Sun icon (shown in dark mode) -->
                    <svg id="theme-icon-sun" class="w-5 h-5 hidden dark:block" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                    </svg>
                    <!-- Moon icon (shown in light mode) -->
                    <svg id="theme-icon-moon" class="w-5 h-5 block dark:hidden" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                    </svg>
                </button>

                <!-- Authenticated Actions -->
                <div sec:authorize="isAuthenticated()" class="flex items-center gap-3">
                    <a th:href="@{/crear-hecho}" class="hidden md:inline-flex btn btn-primary text-sm">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path
                                d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                        </svg>
                        Crear Hecho
                    </a>
                    <a sec:authorize="hasRole('admin_client_role')" th:href="@{/admin}"
                        class="hidden md:inline-flex btn btn-secondary text-sm">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                        </svg>
                        Admin
                    </a>
                    <!-- Profile Dropdown -->
                    <div class="relative" id="profile-menu-container">
                        <button id="profile-menu-button"
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white hover:from-primary-500 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all duration-300 shadow-md hover:shadow-lg hover:scale-105">
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <div id="profile-menu-dropdown"
                            class="absolute hidden right-0 mt-2 w-60 bg-white dark:bg-gray-800 rounded-xl shadow-soft-lg py-2 ring-1 ring-black/5 dark:ring-gray-700 z-50 animate-fade-in-down">
                            <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                                <p class="text-sm font-semibold text-primary-900 dark:text-primary-300"
                                    sec:authentication="name"></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Conectado</p>
                            </div>

                            <a th:href="@{/hechos-pendientes}"
                                class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-gray-700 hover:text-primary-700 dark:hover:text-primary-300 transition-colors">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                Ver hechos pendientes
                            </a>

                            <form th:action="@{/logout}" method="post"
                                class="w-full border-t border-gray-100 dark:border-gray-700 mt-1 pt-1">
                                <button type="submit"
                                    class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
                                    </svg>
                                    Cerrar Sesión
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Anonymous Actions -->
                <div sec:authorize="isAnonymous()" class="hidden md:flex items-center gap-2">
                    <a th:href="@{/auth/login}" class="btn btn-primary text-sm">
                        Iniciar Sesión
                    </a>
                    <a th:href="@{/auth/register}" class="btn btn-secondary text-sm">
                        Registrarse
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="md:hidden hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="mobile-menu">
            <div class="mobile-menu-content dark:bg-gray-800">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
                    <span class="font-bold text-primary-900 dark:text-primary-300 text-lg">Menú</span>
                    <button id="close-mobile-menu" class="p-2 hover:bg-primary-100 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <nav class="space-y-2">
                    <a th:href="@{/}" class="nav-link w-full">Inicio</a>
                    <a th:href="@{/navegar}" class="nav-link w-full">Navegar</a>
                    <a th:href="@{/estadisticas}" class="nav-link w-full">Estadísticas</a>
                    <div sec:authorize="isAuthenticated()" class="pt-4 border-t border-gray-200 mt-4 space-y-2">
                        <a th:href="@{/crear-hecho}" class="btn btn-primary w-full justify-center">Crear Hecho</a>
                        <a sec:authorize="hasRole('admin_client_role')" th:href="@{/admin}"
                            class="btn btn-secondary w-full justify-center">Admin</a>
                    </div>
                    <div sec:authorize="isAnonymous()" class="pt-4 border-t border-gray-200 mt-4 space-y-2">
                        <a th:href="@{/auth/login}" class="btn btn-primary w-full justify-center">Iniciar Sesión</a>
                        <a th:href="@{/auth/register}" class="btn btn-secondary w-full justify-center">Registrarse</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="w-full flex justify-center my-8">
        <div class="content-wrapper w-full max-w-screen-xl px-6 md:px-10 lg:px-16" th:fragment="content"></div>
    </main>

    <footer th:fragment="footer"
        class="bg-gradient-to-r from-primary-100 via-primary-50 to-primary-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 border-t border-primary-200 dark:border-gray-700 transition-colors duration-300">
        <div class="container mx-auto px-4 py-6 text-center">
            <p class="text-primary-700 dark:text-primary-400 font-medium">© 2025 MetaMapa. Todos los derechos
                reservados.</p>
            <p class="text-primary-500 dark:text-gray-500 text-sm mt-1">Plataforma colaborativa de información
                georreferenciada</p>
        </div>
    </footer>

    <div th:fragment="scripts">
        <script th:inline="javascript">
            window.toggleMenu = function (menuId) {
                const menuToToggle = document.getElementById(menuId);
                if (!menuToToggle) return;
                menuToToggle.classList.toggle('hidden');
            };

            document.addEventListener('DOMContentLoaded', function () {
                // Theme Toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', function () {
                        const html = document.documentElement;
                        if (html.classList.contains('dark')) {
                            html.classList.remove('dark');
                            localStorage.setItem('theme', 'light');
                        } else {
                            html.classList.add('dark');
                            localStorage.setItem('theme', 'dark');
                        }
                    });
                }

                // Profile dropdown
                const profileMenuButton = document.getElementById('profile-menu-button');
                const profileMenuDropdown = document.getElementById('profile-menu-dropdown');

                if (profileMenuButton && profileMenuDropdown) {
                    profileMenuButton.addEventListener('click', function (event) {
                        event.stopPropagation();
                        profileMenuDropdown.classList.toggle('hidden');
                    });
                }

                // Mobile menu
                const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                const mobileMenu = document.getElementById('mobile-menu');
                const closeMobileMenu = document.getElementById('close-mobile-menu');

                if (mobileMenuBtn && mobileMenu) {
                    mobileMenuBtn.addEventListener('click', function () {
                        mobileMenu.classList.add('active');
                    });
                }

                if (closeMobileMenu && mobileMenu) {
                    closeMobileMenu.addEventListener('click', function () {
                        mobileMenu.classList.remove('active');
                    });
                    mobileMenu.addEventListener('click', function (e) {
                        if (e.target === mobileMenu) {
                            mobileMenu.classList.remove('active');
                        }
                    });
                }
            });

            document.addEventListener('click', function (event) {
                const profileMenuContainer = document.getElementById('profile-menu-container');
                const profileMenuDropdown = document.getElementById('profile-menu-dropdown');
                if (profileMenuContainer && profileMenuDropdown && !profileMenuDropdown.classList.contains('hidden')) {
                    if (!profileMenuContainer.contains(event.target)) {
                        profileMenuDropdown.classList.add('hidden');
                    }
                }

                document.querySelectorAll('[id^="menu-button-"]').forEach(button => {
                    const menuId = 'menu-' + button.id.substring(12);
                    const menu = document.getElementById(menuId);

                    if (menu && !menu.classList.contains('hidden')) {
                        if (!button.contains(event.target)) {
                            menu.classList.add('hidden');
                        }
                    }
                });
            });

        </script>
    </div>
</body>

</html>