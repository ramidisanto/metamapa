<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head (title='Navegar - Metamapa')}"></head>

<body class="bg-pastel-blue-50 flex flex-col min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-white">

<div th:replace="~{layout/base :: header}"></div>

<main class="w-full flex justify-center my-8 flex-grow">
    <div class="content-wrapper w-full max-w-screen-xl px-6 md:px-10 lg:px-16 flex flex-col">
        <form method="get" th:action="@{/navegar}" class="flex-grow flex flex-col">

            <div class="flex flex-col gap-6 h-[calc(100vh-12rem)]">

                <div class="search-bar-container flex gap-2 w-full items-center">
                    <button type="button" id="toggleFiltros"
                            class="btn-filtros h-10 bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700 flex items-center gap-2 px-4 transition-colors dark:bg-blue-600 dark:hover:bg-blue-700">
                        <img th:src="@{/images/filtro.png}" alt="Filtro" class="w-4 h-4 filter brightness-0 invert">
                        <span id="toggleText">Mostrar Filtros</span>
                    </button>

                    <input type="text" name="textoLibre" th:value="${filtrosActuales.textoLibre}"
                           placeholder="Búsqueda por texto libre..."
                           class="flex-grow h-10 border border-gray-300 rounded-lg pl-3 pr-4 text-sm focus:ring-2 focus:ring-pastel-blue-500 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"/>

                    <button type="submit" name="accion" value="buscarTexto"
                            class="btn-buscar h-10 bg-pastel-blue-600 text-white font-medium rounded-md hover:bg-pastel-blue-700 text-sm px-6 transition-colors dark:bg-blue-600 dark:hover:bg-blue-700">
                        Buscar
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-6 flex-grow min-h-0">

                    <div id="filtrosPanel" class="hidden md:w-1/3 lg:w-1/4 bg-white p-4 rounded-lg shadow-md border border-pastel-blue-200 flex-col transition-all duration-300 overflow-x-hidden dark:bg-gray-800 dark:border-gray-700">
                        <h3 class="text-xl font-bold text-pastel-blue-900 mb-4 flex-shrink-0 dark:text-white">Filtros Avanzados</h3>

                        <div class="space-y-4 overflow-y-auto flex-grow px-2 overflow-x-hidden custom-scrollbar">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Título</label>
                                <input type="text" name="titulo" th:value="${filtrosActuales.titulo}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Colección</label>
                                <select name="coleccionId" id="coleccionSelect" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">Ninguna</option>
                                    <option th:each="col : ${colecciones}" th:value="${col.coleccionId}" th:text="${col.titulo}" th:selected="${col.coleccionId.toString() == filtrosActuales.coleccionId.toString()}"></option>
                                </select>
                            </div>

                            <div id="navegacionCuradaContainer" th:classappend="${(filtrosActuales.coleccionId == null) ? 'hidden' : ''}" class="transition-all">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Modo de Navegación</label>
                                <select name="navegacionCurada" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="false" th:selected="${!filtrosActuales.navegacionCurada}">Irrestricta</option>
                                    <option value="true" th:selected="${filtrosActuales.navegacionCurada}">Curada</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Categoría</label>
                                <select name="categoria" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">Todas</option>
                                    <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}" th:selected="${cat == filtrosActuales.categoria}"></option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Multimedia</label>
                                <select name="contenidoMultimedia" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" th:selected="${filtrosActuales.contenidoMultimedia == null}">Indistinto</option>
                                    <option value="true" th:selected="${filtrosActuales.contenidoMultimedia == true}">Sí</option>
                                    <option value="false" th:selected="${filtrosActuales.contenidoMultimedia == false}">No</option>
                                </select>
                            </div>

                            <div class="pt-2 flex flex-col gap-2">
                                <button type="submit" name="accion" value="filtrar" class="w-full px-4 py-2 bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700 transition-colors dark:bg-blue-600 dark:hover:bg-blue-700">
                                    Aplicar Filtros
                                </button>
                                <a th:href="@{/navegar}" class="w-full text-center px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 transition-colors border border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                                    Limpiar Filtros
                                </a>
                            </div>
                        </div>
                    </div>

                    <div id="contenidoPrincipal" class="w-full flex flex-col gap-4 min-h-0 transition-all duration-300">
                        <div class="flex-grow flex flex-col gap-4 min-h-0">
                            <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0">

                                <div id="mapaContainer" class="md:w-1/2 rounded-lg shadow-lg border overflow-hidden h-full min-h-[400px] md:min-h-0 border-pastel-blue-200 dark:border-gray-700 relative z-0">
                                    <div id="mapa" class="w-full h-full bg-pastel-blue-100 dark:bg-gray-800 z-0" style="min-height: 100%;"></div>
                                </div>

                                <div id="resultadosContainer" class="md:w-1/2 flex flex-col gap-4 h-full min-h-[300px] md:min-h-0 transition-all duration-300">
                                    <h2 class="text-2xl font-bold text-pastel-blue-900 flex-shrink-0 dark:text-white">Resultados (<span th:text="${hechos.size()}">0</span>)</h2>
                                    <div class="flex-grow bg-white p-4 rounded-lg shadow-md border overflow-y-auto min-h-0 border-pastel-blue-200 dark:bg-gray-800 dark:border-gray-700 custom-scrollbar">

                                        <div th:if="${!hechos.isEmpty()}" class="space-y-4">
                                            <div th:each="hecho : ${hechos}">
                                                <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hover:shadow-lg transition-shadow dark:bg-gray-700 dark:border-gray-600">
                                                    <a th:href="@{/ver-hecho/{id}(id=${hecho.idHecho})}" class="block">
                                                        <h4 class="font-bold text-pastel-blue-900 dark:text-white" th:text="${hecho.titulo}">Título</h4>
                                                        <p class="text-sm text-gray-600 mt-1 dark:text-gray-300" th:text="${#strings.abbreviate(hecho.descripcion, 100)}">Desc...</p>
                                                        <div class="text-xs text-gray-500 mt-2 dark:text-gray-400">
                                                            <span th:text="${hecho.categoria}">Categoría</span> |
                                                            <span th:text="${hecho.provincia}">Provincia</span>
                                                        </div>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>

                                        <div th:if="${hechos.isEmpty()}" class="flex flex-col items-center justify-center h-full text-center p-6">
                                            <p class="text-gray-500 dark:text-gray-400">No se encontraron hechos.</p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<div th:replace="~{layout/base :: footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggleFiltros');
        const filtrosPanel = document.getElementById('filtrosPanel');
        const contenidoPrincipal = document.getElementById('contenidoPrincipal');
        const toggleText = document.getElementById('toggleText');
        let filtrosVisibles = false;

        if(toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                filtrosVisibles = !filtrosVisibles;
                if (filtrosVisibles) {
                    filtrosPanel.classList.remove('hidden');
                    filtrosPanel.classList.add('flex');
                    contenidoPrincipal.classList.add('md:w-2/3', 'lg:w-3/4');
                    contenidoPrincipal.classList.remove('md:w-full');
                    if(toggleText) toggleText.textContent = 'Ocultar Filtros';
                } else {
                    filtrosPanel.classList.add('hidden');
                    filtrosPanel.classList.remove('flex');
                    contenidoPrincipal.classList.remove('md:w-2/3', 'lg:w-3/4');
                    contenidoPrincipal.classList.add('md:w-full');
                    if(toggleText) toggleText.textContent = 'Mostrar Filtros';
                }
                setTimeout(() => { if(window.map) window.map.invalidateSize(); }, 300);
            });
        }

        const coleccionSelect = document.getElementById('coleccionSelect');
        const navegacionCuradaContainer = document.getElementById('navegacionCuradaContainer');
        if (coleccionSelect && navegacionCuradaContainer) {
            const updateVis = () => {
                if (coleccionSelect.value !== "") navegacionCuradaContainer.classList.remove('hidden');
                else navegacionCuradaContainer.classList.add('hidden');
            };
            coleccionSelect.addEventListener('change', updateVis);
            updateVis();
        }

        const hechosData = /*[[${hechos}]]*/ [];
        if (typeof L !== 'undefined' && document.getElementById('mapa')) {
            window.map = L.map('mapa').setView([-38.41, -63.61], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(window.map);

            hechosData.forEach(hecho => {
                if (hecho.latitud && hecho.longitud) {
                    L.marker([hecho.latitud, hecho.longitud]).addTo(window.map)
                     .bindPopup(`<b>${hecho.titulo}</b><br><a href="/ver-hecho/${hecho.idHecho}">Ver más</a>`);
                }
            });
            setTimeout(() => { window.map.invalidateSize(); }, 200);
        }
    });
    /*]]>*/
</script>

<div th:replace="~{layout/base :: scripts}"></div>

</body>
</html>