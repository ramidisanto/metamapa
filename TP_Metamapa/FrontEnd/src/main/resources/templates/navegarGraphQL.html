<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/base :: head (title='Navegar - Metamapa')}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-primary-100 dark:bg-gray-900 flex flex-col min-h-screen transition-colors duration-300">

    <div th:replace="~{layout/base :: header}"></div>

    <main class="w-full flex justify-center my-8 flex-grow">

        <div class="content-wrapper w-full max-w-screen-xl px-6 md:px-10 lg:px-16 flex flex-col">
            <div th:if="${successMessage}" class="alert alert-success mb-6">
                <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <span th:text="${successMessage}"></span>
            </div>
            <div class="flex-grow flex flex-col main-content-area h-[calc(100vh-12rem)] md:h-[calc(100vh-12rem)]">

                <div
                    class="search-bar-container mb-6 flex gap-4 items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
                    <button type="button" id="toggleFiltros"
                        class="btn-filtros bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700 flex items-center gap-2 px-4 py-2 transition-colors">
                        <img th:src="@{/images/filtro.png}" alt="Filtro" class="w-4 h-4 filter invert">
                        <span id="toggleText">Mostrar Filtros</span>
                    </button>

                    <input type="text" id="inputBusqueda" placeholder="Búsqueda por texto libre..."
                        class="search-input flex-grow border border-gray-300 rounded-lg pl-3 pr-4 py-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" />

                    <button type="button" id="btnBuscarTexto"
                        class="btn-buscar bg-pastel-blue-600 text-white font-medium rounded-md hover:bg-pastel-blue-700 text-sm px-6 py-2">
                        Buscar
                    </button>
                </div>

                <!-- Backdrop para mobile -->
                <div id="mobileBackdrop" class="mobile-backdrop" onclick="cerrarFiltrosMobile()"></div>

                <div class="flex flex-col md:flex-row gap-6 flex-grow min-h-0 relative">

                    <div id="filtrosPanel"
                        class="hidden md:w-1/3 lg:w-1/4 bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-soft border border-primary-200 dark:border-gray-700 flex-col transition-all duration-300 overflow-hidden">

                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h3 class="text-xl font-bold text-primary-900 dark:text-primary-200">Filtros Avanzados</h3>
                            <!-- Botón cerrar (solo visible en mobile) -->
                            <button type="button" onclick="cerrarFiltrosMobile()"
                                class="mobile-close-btn hidden p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="space-y-4 overflow-y-auto flex-grow px-1 scrollbar-thin">

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Título</label>
                                <input type="text" id="titulo"
                                    class="mt-1 block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white" />
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Colección</label>
                                <select id="coleccionSelect"
                                    class="mt-1 block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="">Ninguna</option>
                                    <option th:each="col : ${colecciones}" th:value="${col.coleccionId}"
                                        th:text="${col.titulo}"></option>
                                </select>
                            </div>

                            <div id="navegacionCuradaContainer" class="hidden">
                                <label class="flex items-center space-x-2 mt-2">
                                    <input type="checkbox" id="navegacionCurada"
                                        class="form-checkbox h-4 w-4 text-blue-600">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Navegación Curada</span>
                                </label>
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Categoría</label>
                                <select id="categoria"
                                    class="mt-1 block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="">Todas</option>
                                    <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}"></option>
                                </select>
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Multimedia</label>
                                <select id="contenidoMultimedia"
                                    class="mt-1 block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="">Indistinto</option>
                                    <option value="true">Sí</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha
                                    Acontecimiento</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="fechaHechoDesde"
                                        class="block w-full px-2 py-1 border  border-gray-300 dark:border-gray-700 rounded text-xs dark:bg-gray-700 dark:text-white" />
                                    <input type="date" id="fechaHechoHasta"
                                        class="block w-full px-2 py-1 border  border-gray-300 dark:border-gray-700 rounded text-xs dark:bg-gray-700 dark:text-white" />
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha
                                    Carga</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="fechaCargaDesde"
                                        class="block w-full px-2 py-1 border  border-gray-300 dark:border-gray-700 rounded text-xs dark:bg-gray-700 dark:text-white" />
                                    <input type="date" id="fechaCargaHasta"
                                        class="block w-full px-2 py-1 border  border-gray-300 dark:border-gray-700 rounded text-xs dark:bg-gray-700 dark:text-white" />
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ubicación</label>
                                <div class="space-y-2">
                                    <select id="pais"
                                        class="block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                        <option value="">País...</option>
                                        <option th:each="p : ${paises}" th:value="${p}" th:text="${p}"></option>
                                    </select>
                                    <select id="provincia"
                                        class="block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                        <option value="">Provincia...</option>
                                        <option th:each="p : ${provincias}" th:value="${p}" th:text="${p}"></option>
                                    </select>
                                    <select id="localidad"
                                        class="block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                        <option value="">Localidad...</option>
                                        <option th:each="l : ${localidades}" th:value="${l}" th:text="${l}"></option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Origen</label>
                                <select id="origen"
                                    class="mt-1 block w-full px-3 py-2 border  border-gray-300 dark:border-gray-700 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="">Todos</option>
                                    <option th:each="entry : ${origenesDeCarga}" th:value="${entry.key}"
                                        th:text="${entry.value}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 flex-shrink-0">
                            <button type="button" id="btnAplicarFiltros"
                                class="flex-1 btn bg-pastel-blue-600 text-white py-2 rounded hover:bg-pastel-blue-700 font-bold shadow">
                                Filtrar
                            </button>
                            <button type="button" id="btnLimpiar"
                                class="flex-1 btn bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300 font-medium">
                                Limpiar
                            </button>
                        </div>
                    </div>

                    <div id="contenidoPrincipal" class="w-full flex flex-col gap-4 min-h-0 transition-all duration-300">
                        <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0 h-full">

                            <div id="mapaContainer"
                                class="md:w-1/2 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden h-full min-h-[300px] relative z-0">
                                <div id="mapa" class="w-full h-full bg-pastel-blue-50"></div>
                                <div id="mapLoader"
                                    class="absolute inset-0 bg-white/60 z-[1000] flex items-center justify-center hidden">
                                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-pastel-blue-600">
                                    </div>
                                </div>
                            </div>

                            <div id="resultadosContainer" class="md:w-1/2 flex flex-col gap-4 h-full min-h-[300px]">
                                <div class="flex justify-between items-center pb-2 border-b dark:border-gray-700">
                                    <h2 class="text-2xl font-bold text-primary-900 dark:text-primary-200 flex-shrink-0">
                                        Resultados (<span id="contadorResultados">0</span>)
                                    </h2>
                                </div>
                                <div id="listaHechosContainer"
                                    class="flex-grow bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm p-3 rounded-2xl shadow-soft border border-primary-200 dark:border-gray-700 overflow-y-auto min-h-0 scrollbar-thin">
                                    <p class="text-center text-gray-500 dark:text-gray-400 p-8">Cargando...</p>
                                </div>
                                <div id="paginacionContainer"
                                    class="flex justify-between items-center mt-3 px-2 hidden">

                                    <button id="btnPrev" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700
                                            text-gray-700 dark:text-gray-300
                                            disabled:opacity-50 disabled:cursor-not-allowed">
                                        Anterior
                                    </button>

                                    <span id="pageInfo" class="text-sm text-gray-600 dark:text-gray-400">
                                    </span>

                                    <button id="btnNext" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700
                                                text-gray-700 dark:text-gray-300
                                                disabled:opacity-50 disabled:cursor-not-allowed">
                                        Siguiente
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="~{layout/base :: footer}"></div>
    <div th:replace="~{layout/base :: scripts}"></div>

    <script th:inline="javascript">


        /*<![CDATA[*/

        // --- CONFIGURACIÓN ---
        const GRAPHQL_URL = '/graphql';
        // Capturamos si es admin desde Thymeleaf para usarlo en JS
        const IS_ADMIN = /*[[${isAdmin}]]*/ false;
        const CSRF_TOKEN = /*[[${_csrf.token}]]*/ '';
        const CSRF_PARAM_NAME = /*[[${_csrf.parameterName}]]*/ '_csrf';

        let map = null;
        let markersLayer = new L.LayerGroup();
        // --- PAGINACIÓN ---
        let currentPage = 0;
        const pageSize = 20; // debe coincidir con el default del backend
        let lastPagedResponse = null;



        // DOM Elements Cache
        const dom = {
            toggleBtn: document.getElementById('toggleFiltros'),
            toggleText: document.getElementById('toggleText'),
            filtrosPanel: document.getElementById('filtrosPanel'),
            contenidoPrincipal: document.getElementById('contenidoPrincipal'),

            btnBuscarTexto: document.getElementById('btnBuscarTexto'),
            btnAplicarFiltros: document.getElementById('btnAplicarFiltros'), // El nuevo botón del panel
            btnLimpiar: document.getElementById('btnLimpiar'),
            inputBusqueda: document.getElementById('inputBusqueda'),

            coleccionSelect: document.getElementById('coleccionSelect'),
            curadaContainer: document.getElementById('navegacionCuradaContainer'),

            listaContainer: document.getElementById('listaHechosContainer'),
            contador: document.getElementById('contadorResultados'),
            loader: document.getElementById('mapLoader')
        };

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
            buscarHechos();

            const fechaDesde = document.getElementById('fechaHechoDesde');
            const fechaHasta = document.getElementById('fechaHechoHasta');
            const fechaCargaDesde = document.getElementById('fechaCargaDesde');
            const fechaCargaHasta = document.getElementById('fechaCargaHasta');

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            if (fechaDesde) fechaDesde.setAttribute('max', todayStr);
            if (fechaHasta) fechaHasta.setAttribute('max', todayStr);
            if (fechaCargaDesde) fechaCargaDesde.setAttribute('max', todayStr);
            if (fechaCargaHasta) fechaCargaHasta.setAttribute('max', todayStr);
        });

        function initMap() {
            if (!document.getElementById('mapa')) return;
            map = L.map('mapa').setView([-34.6, -58.4], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            markersLayer.addTo(map);
        }




        // ===== FUNCIONES PARA MANEJAR FILTROS EN MOBILE =====
        function isMobile() {
            return window.innerWidth < 768;
        }

        function abrirFiltrosMobile() {
            dom.filtrosPanel.classList.remove('hidden');
            dom.filtrosPanel.classList.add('flex');
            dom.toggleText.textContent = 'Ocultar Filtros';

            // En mobile, mostrar backdrop y bloquear scroll
            if (isMobile()) {
                document.getElementById('mobileBackdrop').classList.add('active');
                document.body.classList.add('filtros-open');
            } else {
                // En desktop, ajustar anchos
                dom.contenidoPrincipal.classList.remove('w-full');
                dom.contenidoPrincipal.classList.add('md:w-2/3', 'lg:w-3/4');
            }

            setTimeout(() => map && map.invalidateSize(), 300);
        }

        function cerrarFiltrosMobile() {
            dom.filtrosPanel.classList.add('hidden');
            dom.filtrosPanel.classList.remove('flex');
            dom.toggleText.textContent = 'Mostrar Filtros';

            // Ocultar backdrop y restaurar scroll
            document.getElementById('mobileBackdrop').classList.remove('active');
            document.body.classList.remove('filtros-open');

            // En desktop, restaurar ancho
            dom.contenidoPrincipal.classList.remove('md:w-2/3', 'lg:w-3/4');
            dom.contenidoPrincipal.classList.add('w-full');

            setTimeout(() => map && map.invalidateSize(), 300);
        }

        function setupEventListeners() {
            // Toggle Filtros
            if (dom.toggleBtn) {
                dom.toggleBtn.addEventListener('click', () => {
                    const isHidden = dom.filtrosPanel.classList.contains('hidden');
                    if (isHidden) {
                        abrirFiltrosMobile();
                    } else {
                        cerrarFiltrosMobile();
                    }
                });
            }

            // Eventos de Búsqueda (Texto y Panel)
            dom.btnBuscarTexto.addEventListener('click', buscarHechos);
            if (dom.btnAplicarFiltros) {
                dom.btnAplicarFiltros.addEventListener('click', () => {
                    buscarHechos();
                    // En mobile, cerrar filtros después de aplicar
                    if (isMobile()) {
                        cerrarFiltrosMobile();
                    }
                });
            }

            // Enter en input
            dom.inputBusqueda.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') buscarHechos();
            });

            // Limpiar
            if (dom.btnLimpiar) {
                dom.btnLimpiar.addEventListener('click', () => {
                    document.querySelectorAll('#filtrosPanel input, #filtrosPanel select').forEach(el => {
                        if (el.type === 'checkbox') el.checked = false;
                        else el.value = '';
                    });
                    dom.inputBusqueda.value = '';
                    buscarHechos();
                });
            }

            // Colección -> Navegación Curada
            if (dom.coleccionSelect) {
                dom.coleccionSelect.addEventListener('change', () => {
                    if (dom.coleccionSelect.value) dom.curadaContainer.classList.remove('hidden');
                    else {
                        dom.curadaContainer.classList.add('hidden');
                        document.getElementById('navegacionCurada').checked = false;
                    }
                });
            }
        }

        function buscarHechos() {
            currentPage = 0;
            ejecutarBusqueda();
        }

        async function ejecutarBusqueda() {
            showLoader(true);

            const variables = {
                filtro: {
                    busquedaGeneral: getValue('inputBusqueda'),
                    idColeccion: getValue('coleccionSelect'),
                    titulo: getValue('titulo'),
                    categoria: getValue('categoria'),
                    pais: getValue('pais'),
                    provincia: getValue('provincia'),
                    localidad: getValue('localidad'),
                    contenidoMultimedia: getBoolean('contenidoMultimedia'),
                    origenCarga: getValue('origen'), //lo camiamos para ver si anda antes era origenCarga
                    fechaHechoDesde: getDateISO('fechaHechoDesde'),
                    fechaHechoHasta: getDateISO('fechaHechoHasta'),
                    fechaCargaDesde: getDateISO('fechaCargaDesde'),
                    fechaCargaHasta: getDateISO('fechaCargaHasta'),
                    navegacionCurada: document.getElementById('navegacionCurada')?.checked || false,
                    page: currentPage,
                    size: pageSize
                }
            };

            const query = `
            query($filtro: HechoFilterInput) {
                listarHechos(filtro: $filtro) {
                    content {
                        idHecho
                        titulo
                        descripcion
                        categoria
                        pais
                        provincia
                        localidad
                        fechaAcontecimiento
                        origenCarga
                        latitud
                        longitud
                    }
                    currentPage
                    totalPages
                    totalElements
                    hasNext
                    hasPrevious
                }
            }
        `;

            try {
                const response = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, variables })
                });

                const body = await response.json();

                if (body.errors) {
                    console.error(body.errors);
                    dom.listaContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded">Error: ${body.errors[0].message}</div>`;
                    return;
                }

                const pagedResponse = body.data.listarHechos;

                currentPage = pagedResponse.currentPage;


                lastPagedResponse = pagedResponse;

                renderizarResultados(
                    pagedResponse.content,
                    pagedResponse.totalElements
                );

                renderizarPaginacion(pagedResponse);

            } catch (error) {
                console.error(error);
                dom.listaContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded">Error de conexión con el Agregador (8082).</div>`;
            } finally {
                showLoader(false);
            }
        }



        function renderizarPaginacion(page) {
            const container = document.getElementById('paginacionContainer');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const pageInfo = document.getElementById('pageInfo');

            if (!page || page.totalPages <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            btnPrev.disabled = !page.hasPrevious;
            btnNext.disabled = !page.hasNext;

            pageInfo.textContent = `Página ${page.currentPage + 1} de ${page.totalPages}`;

            btnPrev.onclick = () => {
                if (page.hasPrevious) {
                    currentPage--;
                    ejecutarBusqueda();
                }
            };

            btnNext.onclick = () => {
                if (page.hasNext) {
                    currentPage++;
                    ejecutarBusqueda();
                }
            };
        }


        function renderizarResultados(hechos, totalElements) {
            dom.listaContainer.innerHTML = '';
            dom.contador.innerText = totalElements || hechos.length;
            markersLayer.clearLayers();

            if (!hechos || hechos.length === 0) {
                dom.listaContainer.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-center text-gray-500 dark:text-gray-400 p-8">No se encontraron hechos.</p></div>';
                return;
            }

            const bounds = [];
            /*
                    hechos.forEach(h => {
                        // CARD HTML (Recreando el estilo de tu fragmento)
                        const card = document.createElement('div');
                        card.className = "group relative bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md border border-gray-100 dark:border-gray-700 transition-all duration-300 overflow-hidden mb-3";
            
                        let fecha = h.fechaAcontecimiento ? new Date(h.fechaAcontecimiento).toLocaleDateString() : 'S/F';
                        let categoria = h.categoria || 'General';
            
                        // Botón de eliminar condicional
                        let deleteButton = '';
                        if (IS_ADMIN) {
                            deleteButton = `
                                <form action="/admin/solicitudes/crear" method="post" class="inline" onsubmit="return confirm('¿Solicitar baja de este hecho?')">
                                    <input type="hidden" name="idEntidad" value="${h.idHecho}" />
                                    <input type="hidden" name="tipoEntidad" value="HECHO" />
                                    <input type="hidden" name="tipoSolicitud" value="BAJA" />
                                    <button type="submit" class="text-red-500 hover:text-red-700 p-1" title="Solicitar Baja">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </form>
                            `;
                        }
            
                        card.innerHTML = `
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-wrap gap-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pastel-blue-100 text-pastel-blue-800 dark:bg-pastel-blue-900 dark:text-pastel-blue-200">
                                            ${categoria}
                                        </span>
                                         <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] text-gray-400 border border-gray-200">
                                            ${h.origenCarga || 'N/A'}
                                        </span>
                                    </div>
            
                                    <div class="flex items-center gap-2">
                                        ${deleteButton}
                                        <a href="/ver-hecho/${h["idHecho"]}" class="text-pastel-blue-600 hover:text-pastel-blue-800">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        </a>
                                    </div>
                                </div>
            
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2 leading-tight group-hover:text-pastel-blue-600 transition-colors">
                                    <a href="/ver-hecho/${h["idHecho"]}">${h.titulo}</a>
                                </h3>
            
                                <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2 mb-4">
                                    ${h.descripcion || 'Sin descripción disponible.'}
                                </p>
            
                                <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 border-t border-gray-100 dark:border-gray-700 pt-3">
                                    <div class="flex items-center gap-1">
                                        <span class="truncate max-w-[150px]" title="${h.localidad}, ${h.pais}">
                                            ${h.localidad || ''}, ${h.pais || ''}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span>${fecha}</span>
                                    </div>
                                </div>
                            </div>
                        `;
            */
            hechos.forEach(h => {
                const card = document.createElement('div');
                card.className =
                    "group p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-soft hover:shadow-soft-lg hover:-translate-y-1 hover:border-primary-300 dark:hover:border-primary-500 transition-all duration-300 flex flex-col gap-3 relative overflow-hidden";

                let fecha = h.fechaAcontecimiento ? new Date(h.fechaAcontecimiento).toLocaleDateString() : 'S/F';
                let categoria = h.categoria || 'General';

                const deleteButtonUser = `
        <div class="relative inline-block text-left dropdown-container">
            <button onclick="toggleMenu('menu-${h.idHecho}')"
                class="p-2 rounded-xl text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 hover:bg-primary-50 dark:hover:bg-gray-700 transition-all duration-300"
                title="Opciones del hecho">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 5v.01M12 12v.01M12 19v.01" />
                </svg>
            </button>

            <div id="menu-${h.idHecho}"
                class="origin-bottom-right absolute hidden right-0 bottom-full mb-2 w-56 rounded-xl shadow-soft-lg bg-white dark:bg-gray-800 ring-1 ring-black/5 dark:ring-gray-700 z-50">
                <div class="py-2">
                    <a href="/solicitarEliminacion/${h.idHecho}"
                       class="text-gray-700 dark:text-gray-200 flex items-center gap-3 px-3 py-1.5 text-sm hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 transition-colors rounded-lg">
                       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16">
                            </path>
                            </svg>
                        Solicitar Eliminación
                    </a>
                </div>
            </div>
        </div>
    `;


                const deleteButtonAdmin = `
        <form action="/admin/eliminar-hecho/${h.idHecho}" method="post"
              onsubmit="return confirm('¿Deseas eliminar el Hecho de todas las colecciones?');">
              <input type="hidden" name="${CSRF_PARAM_NAME}" value="${CSRF_TOKEN}" />
            <button type="submit"
                    class="p-2 rounded-xl text-gray-500 dark:text-gray-400
                           hover:text-red-600 dark:hover:text-red-400
                           hover:bg-red-50 dark:hover:bg-red-900/30 transition-all duration-300"
                    title="Eliminar Hecho">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
            </button>
        </form>
    `;

                const deleteButton = IS_ADMIN ? deleteButtonAdmin : deleteButtonUser;


                card.innerHTML = `
            <div
                class="group p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-soft border border-primary-200 dark:border-gray-700 hover:shadow-soft-lg hover:-translate-y-1 hover:border-primary-300 dark:hover:border-primary-500 transition-all duration-300 h-full flex flex-col justify-between relative overflow-hidden">

                <!-- Accent bar on hover -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary-500 to-accent-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left"></div>

                <a href="/ver-hecho/${h.idHecho}" class="flex-grow block">
                    <h4 class="font-bold text-primary-900 dark:text-primary-200 text-lg group-hover:text-primary-700 dark:group-hover:text-primary-300 transition-colors">
                        ${h.titulo}
                    </h4>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">
                        ${h.descripcion || 'Descripción no disponible.'}
                    </p>
                </a>

                <div class="text-xs text-gray-600 dark:text-gray-400 mt-2 pt-2 border-t border-primary-100 dark:border-gray-700 flex justify-between items-center">
                    <span class="flex items-center gap-2 flex-nowrap min-w-0 overflow-hidden">

                        <span class="bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300 px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap flex-shrink-0">
                            ${h.categoria}
                        </span>

                        <span class="text-gray-400 dark:text-gray-500 flex-shrink-0">•</span>

                        <span class="truncate max-w-[120px]">
                            ${h.provincia || ''}
                        </span>

                        <span class="text-gray-400 dark:text-gray-500 flex-shrink-0">•</span>
                    </span>

                    ${deleteButton}

                </div>

                <div class="text-xs text-gray-600 dark:text-gray-400 mt-2 pt-1 flex justify-between items-center">
                    <span class="whitespace-nowrap flex-shrink-0">
                        ${fecha}
                    </span>
                </div>
            </div>`;

                // Centrar mapa al hacer click en la card (excepto en botones)
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('a') && !e.target.closest('button') && h.latitud && h.longitud) {
                        map.flyTo([h.latitud, h.longitud], 10);
                    }
                });

                dom.listaContainer.appendChild(card);

                // MAPA
                if (h.latitud && h.longitud) {
                    const marker = L.marker([h.latitud, h.longitud]);
                    marker.bindPopup(`<b>${h.titulo}</b><br><a href="/ver-hecho/${h.idHecho}">Ver detalle</a>`);
                    markersLayer.addLayer(marker);
                    bounds.push([h.latitud, h.longitud]);
                }
            });

            if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
        }

        // UTILS
        function getValue(id) { const e = document.getElementById(id); return e && e.value ? e.value : null; }
        function getBoolean(id) { const v = getValue(id); return v === 'true' ? true : v === 'false' ? false : null; }
        function getDateISO(id) {
            const v = getValue(id);
            if (!v) return null;
            return id.toLowerCase().includes('hasta') ? v + "T23:59:59" : v + "T00:00:00";
        }
        function showLoader(show) {
            if (dom.loader) show ? dom.loader.classList.remove('hidden') : dom.loader.classList.add('hidden');
        }

        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script th:inline="javascript">

    </script>

</body>

</html>
